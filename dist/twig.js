"use strict";function storage(){var e={},t=testStorage();return t?(e.localStorage=window.localStorage,e.sessionStorage=window.sessionStorage):(e.localStorage=storageTmp(),e.sessionStorage=storageTmp()),e.valid=t,e}function storageTmp(){var e={};return e.o={},e.setItem=function(t,o){e.o[t]=o},e.getItem=function(t){return e.o[t]},e.removeItem=function(t){e.o[t]=void 0,delete e.o[t]},e}function testStorage(){var e=!0,t=window.localStorage;if(t)try{t.setItem("localStorageTest","Hello"),t.removeItem("localStorageTest")}catch(t){e=!1}else e=!1;return!e&&console.error("browser does not support localStorage~~"),e}function install(e,t,o){return __Vue?void console.error("[Twig] already installed. Vue.use(Twig) should be called only once."):(__Vue=e,twiger=new Twig(t,o),Object.defineProperty(__Vue.prototype,"$twig",{configurable:!1,enumerable:!0,get:function(){return twiger.vm.$data}}),void Object.defineProperty(__Vue.prototype,"$twigWarp",{value:twigWarp,writable:!1,enumerable:!0,configurable:!0}))}function twigWarp(e){if("[object Object]"===Object.prototype.toString.call(e)){var t={},o=function(){var o=e[r];Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){return o},set:function(e){console.error('As a twig index, prop "'+r+"\" can't be modified by '='")}})};for(var r in e)o();return t}return console.error("$twigWarp()'s param format should be JSON"),ob}function ready(e){twiger?twiger.ready=e:readyCallBack=e}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},asyncGenerator=function(){function e(e){this.value=e}function t(t){function o(e,t){return new Promise(function(o,n){var s={key:e,arg:t,resolve:o,reject:n,next:null};i?i=i.next=s:(a=i=s,r(e,t))})}function r(o,a){try{var i=t[o](a),s=i.value;s instanceof e?Promise.resolve(s.value).then(function(e){r("next",e)},function(e){r("throw",e)}):n(i.done?"return":"normal",i.value)}catch(e){n("throw",e)}}function n(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?r(a.key,a.arg):i=null}var a,i;this._invoke=o,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),get$1=function e(t,o,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,o);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},set$1=function e(t,o,r,n){var a=Object.getOwnPropertyDescriptor(t,o);if(void 0===a){var i=Object.getPrototypeOf(t);null!==i&&e(i,o,r,n)}else if("value"in a&&a.writable)a.value=r;else{var s=a.set;void 0!==s&&s.call(n,r)}return r},__Vue=void 0,twiger=void 0,readyCallBack=void 0,saveType={localStorage:"localStorage",sessionStorage:"sessionStorage"},Twig=function(){function e(t,o){var r=this;classCallCheck(this,e),this.opErrStr='[Twig] format of "option" like {"key":"xxxx",dataFun:function(data){},saveType:"xxx[optional]"} | [{"key":"xxxx",dataFun:function(data){},saveType:"xxx"},{"key":"xxxx",dataFun:function(data){},saveType:"xxx"}...]',this.prex="_twig_",this.co=o,this.timer=null,this.ready=null,this.vm=null,readyCallBack&&(this.ready=readyCallBack),this.dataTree={},this.watchList={},this.downFlags={},this.readyFlag=!1;var n=storage();this.st=n,this.sessionStorage=n.sessionStorage,this.localStorage=n.localStorage;var a=!1;"[object Object]"===Object.prototype.toString.call(t)?this.explainOption(t):"[object Array]"===Object.prototype.toString.call(t)?t.forEach(function(e){"[object Object]"===Object.prototype.toString.call(e)?r.explainOption(e):a=!0}):a=!0,a&&console.error(this.opErrStr)}return createClass(e,[{key:"explainOption",value:function(e){var t=this;if("string"!=typeof e.key||"function"!=typeof e.dataFun||e.saveType&&"string"!=typeof e.saveType)return void console.error(this.opErrStr);this.downFlags[e.key]=!1;var o=void 0;if(e.saveType===saveType.localStorage||e.saveType===saveType.sessionStorage){this.watchList[e.key]={handler:function(o,r){t.watchHander(o,e.key,e.saveType)},deep:!0},o=this[e.saveType].getItem(this.prex+e.key);try{o=JSON.parse(o)}catch(e){}}var r;if("[object GeneratorFunction]"===Object.prototype.toString.call(e.dataFun)){if(!this.co)throw new Error('[Twig] GeneratorFunction needs "co" mobule');r=this.co.wrap(e.dataFun)}else r=e.dataFun;var n=r(o);"[object Promise]"===Object.prototype.toString.call(n)?n.then(function(o){t.initData(e.key,o,e.saveType)}).catch(function(e){console.error(e)}):this.initData(e.key,n,e.saveType)}},{key:"initData",value:function(e,t,o){var r=this;this.dataTree[e]=t,o!==saveType.localStorage&&o!==saveType.sessionStorage||("object"===("undefined"==typeof t?"undefined":_typeof(t))?(t=JSON.stringify(t),this[o].setItem(this.prex+e,t)):console.error('twig model "'+e+'" should be object')),this.downFlags[e]=!0,setTimeout(function(){r.checkReady()},0)}},{key:"watchHander",value:function(e,t,o){var r=this;this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e)),r[o].setItem(r.prex+t,e)},0)}},{key:"checkReady",value:function(){if(!this.readyFlag){for(var e in this.downFlags)if(this.downFlags[e]===!1)return;this.readyFlag=!0,this.vm=new __Vue({data:this.dataTree,watch:this.watchList}),this.ready()}}}]),e}();"undefined"!=typeof window&&window.Vue&&(window.Twig=Twig),module.exports={install:install,saveType:saveType,twigWarp:twigWarp,ready:ready};
